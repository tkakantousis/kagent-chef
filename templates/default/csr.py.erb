#!/usr/bin/env python
"""Script to register a new cluster host with Hopsworks and get a valid certificate"""

__author__="Jim Dowling <jdowling@kth.se> Antonios Kouzoupis <kouzoupis.ant@gmail.com>"

'''
Install:
 requests:    easy_install requests
 Netifaces:   easy_install netifaces
 IPy:         easy_install ipy
 pyOpenSSL:   apt-get install python-openssl
 MySQLdb:     apt-get install python-mysqldb
 pexpect:     apt-get install python-pexpect
'''

import ConfigParser
import socket
import random
import string
import netifaces
import sys
import logging
import logging.handlers
import os
import argparse
import requests
import json
import time
import subprocess

from IPy import IP
from OpenSSL import crypto
from os.path import join, exists

CONFIG_FILE = "<%= node[:kagent][:base_dir] %>/config.ini"
LOG_FILE = "<%= node[:kagent][:base_dir] %>/csr.log"
CERT_FILE = "<%= node[:kagent][:certs_dir] %>/pub.pem"
CA_FILE = "<%= node[:kagent][:certs_dir] %>/ca_pub.pem"
KEY_FILE = "<%= node[:kagent][:certs_dir] %>/priv.key"
SERVER_KEYSTORE = "<%= @kstore %>"
SERVER_TRUSTSTORE = "<%= @tstore %>"
CLIENT_TRUSTSTORE = "<%= node["kagent"]["keystore_dir"] %>/node_client_truststore.jks"

class Certificate:
    """Class representing X509 certificate for host"""
    
    def __init__(self, config):
        self._config = config
        self._private_key = None
        self._certificate = None
        self._ca_certificate = None        
        
    def create_csr(self):
        """Generates a cryptographic key-pair and a CSR"""

        LOG.info("Creating Certificate Signing Request")
        pKey = self._generate_key()
        # Create CSR
        csr = crypto.X509Req()
        csr.get_subject().C = "SE"
        csr.get_subject().ST = "Sweden"
        csr.get_subject().L = "Stockholm"
        csr.get_subject().O = "Hopsworks"
        csr.get_subject().OU = "LC"

        # CN should be the hostname of the server
        _hostname = self._getHostname()
        LOG.debug("Hostname used in CN is {}".format(_hostname))
        csr.get_subject().CN = _hostname
        csr.set_pubkey(pKey)

        ### For kafka fix
        base_constraints = ([crypto.X509Extension("keyUsage", False, "Digital Signature, Non Repudiation, Key Encipherment")])
        x509_extensions = base_constraints
        # If there are SAN entries, append the base_constraints to include them.
        san_constraint = crypto.X509Extension("subjectAltName", False, "DNS: %s" % self._config.hostname)
        x509_extensions.append(san_constraint)
        csr.add_extensions(x509_extensions)
        ### End Kafka

        csr.sign(pKey, 'sha256')
        self.csr_req = crypto.dump_certificate_request(crypto.FILETYPE_PEM, csr)
        self._private_key = crypto.dump_privatekey(crypto.FILETYPE_PEM, pKey)
        LOG.debug("Finished CSR")

    def set_certificate(self, certificate):
        """Setter for a host certificate returned by Hopsworks"""
        self._certificate = certificate

    def set_ca_certificate(self, ca_certificate):
        """Setter for CA certificate returned by Hopsworks"""
        self._ca_certificate = ca_certificate

    def keystoresExist(self):
        """Checks if keystore, truststore and client_truststore exist in the predefined directory"""
        return exists(SERVER_KEYSTORE) and exists(SERVER_TRUSTSTORE) and exists(CLIENT_TRUSTSTORE)
    
    def store(self):
        """Write certificate and private key in current directory"""
        LOG.debug("Storing certificate, key and CA certificate")
        cert_dir = os.path.dirname(os.path.abspath(__file__))

        if self._ca_certificate is not None:
            with open(join(cert_dir, CA_FILE), "wt") as fd:
                fd.write(self._ca_certificate)
                
        if self._private_key is not None:
            with open(join(cert_dir, KEY_FILE), "wt") as fd:
                fd.write(self._private_key)

        if self._certificate is not None:
            with open(join(cert_dir, CERT_FILE), "wt") as fd:
                fd.write(self._certificate)
        LOG.info("Flushed crypto material to filesystem")
        
    def _generate_key(self):
        """Generates cryptographic pair"""

        LOG.debug("Generating cryptographic key-pair")
        pKey = crypto.PKey()
        pKey.generate_key(crypto.TYPE_RSA, 2048)
        
        return pKey
    
    def _getHostname(self):
        """Get and prepare host's hostname for CN"""
        hShort = self._config.hostname
        if (len(self._config.hostname) > 63):
            hShort = self._config.hostname[0:63]
            validEndChar = False
            offset = 63
            while (validEndChar == False):
                if (hShort[offset].isalnum()):
                    hShort = self._config.hostname[0:offset]
                    validEndChar = True
                offset -= 1
        return hShort


class Host:
    """Class representing a host in the cluster"""
    form_headers = {'Content-Type': 'application/x-www-form-urlencoded',
                     'User-Agent': 'hops-csr'}
    json_headers = {'User-Agent': 'Agent', 'content-type': 'application/json'}
    
    def __init__(self, conf, certificate):
        LOG.debug("Creating new host")
        self._conf = conf
        self._certificate = certificate

    def rotate_key(self, session, command_id):
        """Public method to perform key rotation"""
        self._rotate_key_internal(session, command_id)

    def _rotate_key_internal(self, session, command_id):
        self._login(session)
        payload = {}
        payload["csr"] = self._certificate.csr_req
        payload["agent-password"] = self._conf.agent_password
        payload["host-id"] = self._conf.host_id
        payload["id"] = command_id
        LOG.info("Rotating service key")
        LOG.debug("Rotation url is {0}".format(self._conf.rotate_url))
        response = session.post(self._conf.rotate_url, headers=self.json_headers, data=json.dumps(payload), verify=False)

        if (response.status_code != requests.codes.ok):
            raise Exception('Could not rotate service certificate Status code: {0} Reason: {1}'
                            .format(response.status_code, response.text))
        json_response = json.loads(response.content)
        self._extract_crypto_material(json_response)
    
    def register_host(self, session):
        """Public method to register a new host and sign its CSR"""
        registered = False
        while not registered:
            try :
                self._register_host_internal(session)
                registered = True
            except Exception, e:
                LOG.warning("Error while registering host {0}, will try again in {1} seconds..."
                            .format(e, self._conf.heartbeat_interval))
                time.sleep(self._conf.heartbeat_interval)

    def _register_host_internal(self, session):
        self._login(session)
        payload = {}
        payload["csr"] = self._certificate.csr_req
        payload["agent-password"] = self._conf.agent_password
        payload["host-id"] = self._conf.host_id
        LOG.info("Registering with Hopsworks")
        response = session.post(self._conf.register_url, headers=self.json_headers, data=json.dumps(payload), verify=False)

        if (response.status_code != requests.codes.ok):
            raise Exception('Could not register: Unknown host id or internal error on the dashboard (Status code: {0} - {1}).'
                            .format(response.status_code, response.text))

        json_response = json.loads(response.content)
        self._extract_crypto_material(json_response)
        
        hadoopHome = json_response["hadoopHome"]
        self._conf.set_conf_value('agent', 'hadoop-home', hadoopHome)
        self._conf.dump_to_file()

    def _extract_crypto_material(self, json_response):
        """Extract crypto material from the response from hopsworks-ca and write them locally"""
        certificate = json_response["pubAgentCert"]
        caCertificate = json_response["caPubCert"]
        self._certificate.set_certificate(certificate)
        self._certificate.set_ca_certificate(caCertificate)
        self._certificate.store()
        
    def _login(self, session):
        """Helper method to login to Hopsworks"""
        login_payload = {'email': self._conf.server_username, 'password': self._conf.server_password}
        # First login
        LOG.debug("Logging in to Hopsworks")
        response = session.post(self._conf.login_url, headers=self.form_headers, data=login_payload, verify=False)
        if (response.status_code != requests.codes.ok):
            raise Exception('Could not login to Hopsworks')

        LOG.debug("Logged in successfully")        

        
class Config:
    """Class representig kagent configuration"""

    _log_level_mapping = {
        'DEBUG': logging.DEBUG,
        'INFO': logging.INFO,
        'WARNING': logging.WARNING,
        'ERROR': logging.ERROR,
        'CRITICAL': logging.CRITICAL}
    
    def __init__(self, configFile):
        self._configFile = configFile

    def set_conf_value(self, section, name, value):
        """Set a new configuration property"""
        if self._config is not None:
            self._config.set(section, name, value)

    def dump_to_file(self):
        """Dump configuration object to file"""
        with open(CONFIG_FILE, 'wb') as fd:
            self._config.write(fd)
            
    def read_conf(self):
        """Load configuration from file"""
        try:
            self._config = ConfigParser.ConfigParser()
            self._config.read(self._configFile)
            self.server_url = self._config.get('server', 'url')
            self.register_url = self.server_url + self._config.get('server', 'path-register')
            self.rotate_url = self.server_url + self._config.get('server', 'path-rotate')
            self.login_url = self.server_url + self._config.get('server', 'path-login')
            self.server_username = self._config.get('server', 'username')
            self.server_password = self._config.get('server', 'password')
            self.heartbeat_interval = self._config.getfloat('agent', 'heartbeat-interval')
            logging_level_str = self._config.get('agent', 'logging-level')
            self.logging_level = self._get_logging_level(logging_level_str)
            self.max_log_size = self._config.getint('agent', 'max-log-size')
            self.agent_pidfile = self._config.get('agent', 'pid-file')
            self.network_interface = self._config.get('agent', 'network-interface')

            if (self._config.has_option("agent", "hostname")):
                self.hostname = self._config.get("agent", "hostname")
            else:
                self.hostname = socket.gethostbyaddr(eth0_ip)[0]

            if (self._config.has_option("agent", "host-id")):
                self.host_id = self._config.get("agent", "host-id")
            else:
                self.host_id = self.hostname

            # First time we run csr.py, it will generate an agent password and store it in the config.ini file.
            # The agent password is then stored in the 'hosts' table in hopsworks.
            if (self._config.has_option("agent", "password")):
                self.agent_password = self._config.get('agent', 'password')
            else:
                self.agent_password = ''.join(random.SystemRandom().choice(string.ascii_uppercase + string.digits) for _ in range(8))
                self._config.set('agent', 'password', self.agent_password)
                with open(self._configFile, 'wb') as configfile:
                    self._config.write(configfile)

            # TODO find public/private IP addresses
            self.public_ip = None
            self.private_ip = None
            self.eth0_ip = netifaces.ifaddresses(self.network_interface)[netifaces.AF_INET][0]['addr']
            if (IP(self.eth0_ip).iptype() == "PUBLIC"):
                self.public_ip = self.eth0_ip
            else:
                self.private_ip = self.eth0_ip

            try:
                self.hostname = socket.gethostbyaddr(self.eth0_ip)[0]
            except socket.herror:
                try:
                    self.hostname = socket.gethostname()
                except socket.herror:
                    self.hostname = "localhost"
                    
            if (self._config.has_option("agent", "host-id")):
                self.host_id = self._config.get("agent", "host-id")
            else:
                self.host_id = self.hostname
        except Exception, e:
            print ("Exception while reading {0}: {1}".format(self._configFile, e))
            sys.exit(1)

    def _get_logging_level(self, log_level_str):
        return self._log_level_mapping.get(log_level_str.upper(), logging.INFO)

def setup_logging(max_log_size, logLevel):
    """Setup logging utilities"""
    global LOG
    LOG = logging.getLogger('csr-agent')
    LOG.setLevel(logLevel)
    file_handler = logging.handlers.RotatingFileHandler(LOG_FILE, mode='a', maxBytes=max_log_size, backupCount=5)
    file_handler.setLevel(logLevel)
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logLevel)
    formatter = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
    file_handler.setFormatter(formatter)
    console_handler.setFormatter(formatter)
    LOG.addHandler(file_handler)
    LOG.addHandler(console_handler)
    requests_log = logging.getLogger("requests.packages.urllib3")
    requests_log.setLevel(logLevel)
    requests_log.propagate = True


    
if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Register host with Hopsworks and get certificate.')

    parser.add_argument("operation", help="Operation to perform")
    subparsers = parser.add_subparsers(dest='operation', help="Modes of operation")

    parser_i = subparsers.add_parser('initialize', help="Register with Hopsworks")

    parser_r = subparsers.add_parser('rotate', help="Perform certificate rotation")
    parser_r.add_argument("-c", "--commandid", help="Command ID from Hopsworks", default="-1")

    args = parser.parse_args()
    
    config = Config(CONFIG_FILE)
    config.read_conf()
    setup_logging(config.max_log_size, config.logging_level)
    LOG.info("Hops CSR-agent started.")
    LOG.info("Register URL: {0}".format(config.register_url))
    LOG.info("Public IP: {0}".format(config.public_ip))
    LOG.info("Private IP: {0}".format(config.private_ip))

    agent_pid = str(os.getpid())
    file(config.agent_pidfile, 'w').write(agent_pid)
    LOG.info("Hops CSR-agent PID: {0}".format(agent_pid))

    cert = Certificate(config)
    if args.operation == "initialize":
        LOG.debug("Initializing")
        
        if cert.keystoresExist():
            LOG.warning("Keystores already exist, aborting initializing")
            sys.exit(2)
            
        cert.create_csr()

        h = Host(config, cert)
        with requests.Session() as session:
            try:
                h.register_host(session)
                subprocess.check_call("<%= node[:kagent][:base_dir] %>/keystore.sh")
            except Exception, e:
                LOG.error("Error while registering host: {0}".format(e))
                raise e
            
    elif args.operation == "rotate":
        LOG.debug("Key rotation")

        cert.create_csr()
        h = Host(config, cert)
        with requests.Session() as session:
            try:
                h.rotate_key(session, args.commandid)
                subprocess.call("<%= node[:kagent][:base_dir] %>/keystore.sh")
            except Exception, e:
                LOG.error("Error while rotating key: {0}".format(e))
                raise e
    
